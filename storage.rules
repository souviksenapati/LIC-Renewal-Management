rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper to get user role from Firestore
    function getUserRole() {
      let userDoc = firestore.get(/databases/(default)/documents/users/$(request.auth.uid));
      return userDoc != null && userDoc.data != null ? userDoc.data.role : null;
    }
    
    // Receipts - staff can upload images only, max 10MB
    match /receipts/{receiptFile} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                   getUserRole() == 'staff' &&
                   request.resource.size < 10 * 1024 * 1024 &&
                   request.resource.contentType.matches('image/(jpeg|jpg|png)');
    }
    
    // Policy uploads - admin only, PDFs only, max 50MB
    match /policy-uploads/{pdfFile} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                   getUserRole() == 'admin' &&
                   request.resource.size < 50 * 1024 * 1024 &&
                   request.resource.contentType == 'application/pdf';
    }
  }
}
